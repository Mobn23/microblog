---
- name: Ensure Docker is installed
  ansible.builtin.import_role:
    name: docker

- name: Run Microblog prod container on appserver
  become: true
  community.docker.docker_container:
    name: "{{ microblog_container_name }}"
    image: "{{ microblog_image }}"
    restart_policy: always
    env:
      # Adjust to whatever your app actually reads
      DATABASE_URL: "{{ microblog_database_url }}"
      MICROBLOG_VERSION: "{{ release_tag }}"
    published_ports:
      - "{{ microblog_port }}:5000"
    state: started

- name: Wait for MySQL to accept connections from appserver
  ansible.builtin.wait_for:
    host: "{{ hostvars[groups['database'][0]].ansible_default_ipv4.address }}"
    port: 3306
    delay: 2
    timeout: 180
    state: started

- name: Run database migrations (once) using app venv
  ansible.builtin.command:
    cmd: >
      docker exec {{ microblog_container_name }}
      /bin/sh -lc
      'export FLASK_APP=microblog.py;
       /home/microblog/.venv/bin/python -m flask db upgrade'
  run_once: true
  delegate_to: "{{ groups['appserver'][0] }}"

- name: Read running container info (verify version)
  community.docker.docker_container_info:
    name: "{{ microblog_container_name }}"
  register: mb_container

- name: Verify correct image is running
  ansible.builtin.assert:
    that:
      - mb_container.container is defined
      - mb_container.container.Config.Image == microblog_image
    fail_msg: >
      Wrong image running on {{ inventory_hostname }}.
      Expected {{ microblog_image }},
      got {{ mb_container.container.Config.Image | default('NONE') }}.
    success_msg: >
      OK: {{ inventory_hostname }} runs {{ microblog_image }}
